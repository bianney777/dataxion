<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Finca</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.0/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/css/gestionfinca.css">
  <!-- Scripts: primero app utilidades globales (errores/toasts), luego módulo específico -->
  <script src="/js/app.js" defer></script>
  <script src="/js/gestionfinca.js" defer></script>
</head>
<body>
  <%- include('partial/header') %>
  <div class="layout">
    <%- include('partial/sidebar') %>
    <div class="feed" data-fincas-feed>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-green-600 text-transparent bg-clip-text tracking-tight">Gestión de Finca</h2>
        <div class="hidden md:flex gap-2" aria-live="polite" aria-atomic="true">
          <span class="metric-chip">Total fincas: <span id="metricTotalFincas"><%= (fincas && fincas.length) || 0 %></span></span>
          <% if (selectedFinca && lotes) { %><span class="metric-chip">Lotes: <%= lotes.length %></span><% } %>
        </div>
      </div>
      <p class="mb-4 text-gray-600">Gestiona fincas y lotes con vista dinámica y expansión rápida.</p>

      <!-- Formularios (inline fase 1) -->
      <% if (selectedFinca && selectedFinca.id_finca) { %>
        <!-- ...existing code... (form edición finca) -->
        <div class="section-header">
          <h3 class="pill-title">Editar finca</h3>
          <span class="metric-chip">ID <%= selectedFinca.id_finca %></span>
        </div>
        <div class="gradient-bar"></div>
        <!-- ...existing code... -->
        <form action="/gestionfinca/<%= selectedFinca.id_finca %>/update" method="POST" class="mb-10 glass-card rounded-xl p-6">
          <!-- ...existing code fields unchanged... -->
          <!-- Mantengo campos originales para no romper backend -->
          <div class="form-grid">
            <div class="input-group floating">
              <input type="text" name="nombre_finca" value="<%= selectedFinca.nombre_finca %>" required>
              <label class="animated-label">Nombre de la finca</label>
            </div>
            <div class="input-group floating">
              <input type="number" step="0.0001" name="area_total" value="<%= selectedFinca.area_total %>" required>
              <label>Área total (ha)</label>
            </div>
            <div class="input-group floating">
              <input type="text" name="ubicacion" value="<%= selectedFinca.ubicacion %>">
              <label>Ubicación</label>
            </div>
            <div class="input-group floating">
              <input type="number" step="0.00000001" name="latitud" value="<%= selectedFinca.latitud %>">
              <label>Latitud</label>
            </div>
            <div class="input-group floating">
              <input type="number" step="0.00000001" name="longitud" value="<%= selectedFinca.longitud %>">
              <label>Longitud</label>
            </div>
            <div class="input-group floating">
              <input type="number" step="0.01" name="altitud" value="<%= selectedFinca.altitud %>">
              <label>Altitud (m)</label>
            </div>
            <div class="input-group floating col-span-2">
              <textarea name="descripcion"><%= selectedFinca.descripcion %></textarea>
              <label>Descripción</label>
            </div>
            <div class="input-group floating select-wrapper">
              <select name="estado">
                <option value="activa" <%= selectedFinca.estado==='activa'?'selected':'' %>>Activa</option>
                <option value="inactiva" <%= selectedFinca.estado==='inactiva'?'selected':'' %>>Inactiva</option>
                <option value="en_planificacion" <%= selectedFinca.estado==='en_planificacion'?'selected':'' %>>En planificación</option>
              </select>
              <label>Estado</label>
            </div>
            <div class="input-group floating select-wrapper">
              <select name="id_zona" required>
                <option value="" disabled <%= !selectedFinca.id_zona ? 'selected' : '' %>>Selecciona zona</option>
                <% if (typeof zonas !== 'undefined' && zonas && zonas.length) { zonas.forEach(z => { %>
                  <option value="<%= z.id_zona %>" <%= z.id_zona === selectedFinca.id_zona ? 'selected' : '' %>><%= z.nombre_zona %> (<%= z.region || z.pais || '' %>)</option>
                <% }) } %>
              </select>
              <label>Zona geográfica</label>
            </div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="submit" class="btn btn-gradient btn-sm">Guardar cambios</button>
            <a href="/gestionfinca" class="btn btn-outline btn-sm">Cancelar</a>
          </div>
        </form>
      <% } else { %>
        <div class="section-header">
          <h3 class="pill-title">Registrar finca</h3>
          <span class="live-badge">ACTIVO</span>
        </div>
        <div class="gradient-bar"></div>
        <!-- Form crear finca (sin cambios de campos) -->
        <form action="/gestionfinca/create" method="POST" class="mb-10 glass-card rounded-xl p-6" id="formNuevaFinca">
          <div class="form-grid">
            <div class="input-group floating"><input type="text" name="nombre_finca" required><label>Nombre de la finca</label></div>
            <div class="input-group floating"><input type="number" step="0.0001" name="area_total" required><label>Área total (ha)</label></div>
            <div class="input-group floating"><input type="text" name="ubicacion"><label>Ubicación</label></div>
            <div class="input-group floating"><input type="number" step="0.00000001" name="latitud"><label>Latitud</label></div>
            <div class="input-group floating"><input type="number" step="0.00000001" name="longitud"><label>Longitud</label></div>
            <div class="input-group floating"><input type="number" step="0.01" name="altitud"><label>Altitud (m)</label></div>
            <div class="input-group floating col-span-2"><textarea name="descripcion"></textarea><label>Descripción</label></div>
            <div class="input-group floating select-wrapper"><select name="estado"><option value="activa">Activa</option><option value="inactiva">Inactiva</option><option value="en_planificacion">En planificación</option></select><label>Estado</label></div>
            <div class="input-group floating select-wrapper"><select name="id_zona" required><option value="" disabled selected>Selecciona zona</option><% if (typeof zonas !== 'undefined' && zonas && zonas.length) { zonas.forEach(z => { %><option value="<%= z.id_zona %>"><%= z.nombre_zona %> (<%= z.region || z.pais || '' %>)</option><% }) } %></select><label>Zona geográfica</label></div>
          </div>
          <div class="flex gap-4 pt-2 items-center">
            <button type="submit" class="btn btn-gradient btn-sm">Registrar Finca</button>
            <span class="text-[11px] text-slate-500 font-medium hidden md:inline">Completa los campos obligatorios *</span>
          </div>
        </form>
      <% } %>

      <!-- Listado dinámico de fincas -->
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-3">
        <h3 class="text-sm font-semibold uppercase tracking-wider text-slate-600 flex items-center gap-3">Mis fincas
          <select id="filterEstado" class="text-[11px] font-medium bg-slate-100 border border-slate-300 rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200">
            <option value="">Todos</option>
            <option value="activa">Activas</option>
            <option value="inactiva">Inactivas</option>
            <option value="en_planificacion">Planificación</option>
          </select>
        </h3>
        <div class="flex flex-wrap gap-2 export-toolbar">
          <button id="exportFincasBtn" class="btn btn-xs btn-outline">CSV</button>
          <button id="exportFincasExcelBtn" class="btn btn-xs btn-success">Excel</button>
          <button id="exportFincasPdfBtn" class="btn btn-xs btn-danger">PDF</button>
        </div>
      </div>
      <div class="grid gap-5 md:grid-cols-2 xl:grid-cols-3 mb-10" data-fincas-container aria-live="polite" aria-busy="false">
        <!-- Contenido dinámico gestionfinca.js -->
        <div class="col-span-full text-center text-sm text-slate-500 py-4">Cargando fincas...</div>
      </div>
      <div data-fincas-pagination class="mb-10"></div>

      <!-- Lotes: sigue mostrador tradicional si se llega vía ruta /:id_finca/lotes -->
      <% if (selectedFinca) { %>
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mt-2 mb-3">
          <h3 class="text-sm font-semibold uppercase tracking-wider text-slate-600 flex items-center gap-3">Lotes de la finca</h3>
          <div class="flex flex-wrap gap-2 export-toolbar">
            <button id="exportLotesBtn" class="btn btn-xs btn-outline">CSV</button>
            <button id="exportLotesExcelBtn" class="btn btn-xs btn-success">Excel</button>
            <button id="exportLotesPdfBtn" class="btn btn-xs btn-danger">PDF</button>
          </div>
        </div>
        <div class="grid gap-5 md:grid-cols-2 xl:grid-cols-3 mb-4" data-lotes-container data-id-finca="<%= selectedFinca.id_finca || selectedFinca %>">
          <div class="col-span-full text-center text-sm text-slate-500 py-4">(Se cargará dinámicamente o usar expansión rápida arriba)</div>
        </div>
        <div data-lotes-pagination class="mb-10"></div>
      <% } %>

      <!-- Formularios de lotes (mantener sin cambios para no romper flujos existentes) -->
      <!-- Reintroducción de formularios de lote conservando lógica original -->
      <% if (selectedLote && selectedLote.id_lote) { %>
        <div class="section-header mt-10">
          <h3 class="pill-title">Editar lote</h3>
          <span class="metric-chip">ID LOTE <%= selectedLote.id_lote %></span>
        </div>
        <div class="gradient-bar"></div>
        <form action="/gestionfinca/lotes/<%= selectedLote.id_lote %>/update" method="POST" class="mb-10 glass-card p-6">
          <div class="form-grid">
            <input type="hidden" name="id_finca" value="<%= selectedLote.id_finca %>">
            <div class="input-group floating"><input type="text" name="nombre_lote" value="<%= selectedLote.nombre_lote %>" required><label>Nombre del lote</label></div>
            <div class="input-group floating"><input type="number" step="0.0001" name="area" value="<%= selectedLote.area %>" required><label>Área (ha)</label></div>
            <div class="input-group floating"><input type="text" name="coordenadas" value="<%= selectedLote.coordenadas %>"><label>Coordenadas</label></div>
            <div class="input-group floating col-span-2"><textarea name="descripcion"><%= selectedLote.descripcion %></textarea><label>Descripción</label></div>
            <div class="input-group floating select-wrapper">
              <select name="tipo_suelo">
                <option value="arcilloso" <%= selectedLote.tipo_suelo==='arcilloso'?'selected':'' %>>Arcilloso</option>
                <option value="limoso" <%= selectedLote.tipo_suelo==='limoso'?'selected':'' %>>Limoso</option>
                <option value="arenoso" <%= selectedLote.tipo_suelo==='arenoso'?'selected':'' %>>Arenoso</option>
                <option value="franco" <%= selectedLote.tipo_suelo==='franco'?'selected':'' %>>Franco</option>
                <option value="otros" <%= selectedLote.tipo_suelo==='otros'?'selected':'' %>>Otros</option>
              </select>
              <label>Tipo de suelo</label>
            </div>
            <div class="input-group floating"><input type="number" step="0.1" name="ph_suelo" value="<%= selectedLote.ph_suelo %>"><label>pH</label></div>
            <div class="input-group floating"><input type="number" step="0.01" name="capacidad_agua" value="<%= selectedLote.capacidad_agua %>"><label>Capacidad agua</label></div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="submit" class="btn btn-gradient btn-sm">Guardar cambios</button>
            <a href="/gestionfinca/<%= selectedLote.id_finca %>/lotes" class="btn btn-outline btn-sm">Cancelar</a>
          </div>
        </form>
      <% } else if (selectedFinca) { %>
        <div class="section-header mt-10">
          <h3 class="pill-title">Registrar lote</h3>
          <span class="metric-chip">Finca <%= (selectedFinca.nombre_finca || selectedFinca) %></span>
        </div>
        <div class="gradient-bar"></div>
        <form action="/gestionfinca/lotes/create" method="POST" class="mb-10 glass-card p-6">
          <div class="form-grid">
            <input type="hidden" name="id_finca" value="<%= selectedFinca.id_finca || selectedFinca %>">
            <div class="input-group floating"><input type="text" name="nombre_lote" required><label>Nombre del lote</label></div>
            <div class="input-group floating"><input type="number" step="0.0001" name="area" required><label>Área (ha)</label></div>
            <div class="input-group floating"><input type="text" name="coordenadas"><label>Coordenadas</label></div>
            <div class="input-group floating col-span-2"><textarea name="descripcion"></textarea><label>Descripción</label></div>
            <div class="input-group floating select-wrapper">
              <select name="tipo_suelo">
                <option value="arcilloso">Arcilloso</option>
                <option value="limoso">Limoso</option>
                <option value="arenoso">Arenoso</option>
                <option value="franco">Franco</option>
                <option value="otros">Otros</option>
              </select>
              <label>Tipo de suelo</label>
            </div>
            <div class="input-group floating"><input type="number" step="0.1" name="ph_suelo"><label>pH</label></div>
            <div class="input-group floating"><input type="number" step="0.01" name="capacidad_agua"><label>Capacidad agua</label></div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="submit" class="btn btn-gradient btn-sm">Registrar Lote</button>
          </div>
        </form>
      <% } %>
      <!-- Fin reintroducción lotes -->
    </div>
    <aside class="rightbar">
      <div class="right-card" aria-live="polite" aria-atomic="true">
        <h4 class="text-xs font-semibold tracking-wider text-slate-500 uppercase">Métricas rápidas</h4>
        <div class="text-[11px] flex flex-col gap-1">
          <div>Total fincas: <span id="metricTotalFincas"><%= (fincas && fincas.length) || 0 %></span></div>
          <div>Área acumulada: <span id="metricAreaTotal">—</span></div>
          <div>% Activas: <span id="metricActivas">—</span></div>
          <div>pH promedio: <span id="metricPh">—</span></div>
        </div>
      </div>
      <div class="right-card">
        <h4 class="text-xs font-semibold tracking-wider text-slate-500 uppercase">Atajos</h4>
        <button class="btn-modern bg-blue-600 text-white px-3 py-2 rounded-md text-xs font-medium hover:bg-blue-700" onclick="scrollTo(0,0)">Ir arriba</button>
      </div>
    </aside>
  </div>
  <!-- Export progress overlay -->
  <div id="exportProgress" class="hidden">
    <div class="label"><span>Exportando</span><span class="percent"></span></div>
    <div class="track"><div class="bar"></div></div>
  </div>
  <!-- Librerías externas para export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <%- include('partial/footer') %>
</body>
</html>
