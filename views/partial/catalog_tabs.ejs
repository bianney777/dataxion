<% /* Rebuild catÃ¡logo utilitario con fallback simple y hooks claros */ %>
<div class="catalog-util" id="catalogUtilRoot" data-version="2">
  <header class="cu-header">
    <nav class="cu-tabs" role="tablist">
      <button class="cu-tab active" data-cu-tab="cultivos" role="tab" aria-selected="true">Cultivos (<%= categoriasCultivo.length %>)</button>
      <button class="cu-tab" data-cu-tab="insumos" role="tab" aria-selected="false">Insumos (<%= categoriasInsumo.length %>)</button>
    </nav>
    <div class="cu-tools">
      <div class="cu-search-wrap"><input id="cuSearch" type="search" placeholder="Buscar..." aria-label="Buscar" /></div>
      <select id="cuSort" class="cu-sort" aria-label="Ordenar">
        <option value="name_asc">Nombre A-Z</option>
        <option value="name_desc">Nombre Z-A</option>
        <option value="count_desc">MÃ¡s elementos</option>
        <option value="count_asc">Menos elementos</option>
        <option value="dias_desc">(Cultivos) MÃ¡s dÃ­as</option>
        <option value="dias_asc">(Cultivos) Menos dÃ­as</option>
      </select>
      <div class="cu-adv-filters" id="cuAdvFilters">
        <details>
          <summary class="cf-summary">Filtros</summary>
          <div class="cf-body">
            <label>DÃ­as (min)<input type="number" id="fDiasMin" class="cf-input" /></label>
            <label>DÃ­as (max)<input type="number" id="fDiasMax" class="cf-input" /></label>
            <label>Tipo Insumo<select id="fTipoInsumo" class="cf-input"><option value="">Todos</option><option value="fertilizante">Fertilizante</option><option value="plaguicida">Plaguicida</option><option value="semilla">Semilla</option><option value="herramienta">Herramienta</option><option value="equipo">Equipo</option><option value="otro">Otro</option></select></label>
            <label><input type="checkbox" id="fSoloFavoritos" /> Favoritos</label>
            <div class="cf-actions">
              <button type="button" id="fReset" class="btn btn-xs">Reset</button>
            </div>
          </div>
        </details>
      </div>
      <div class="cu-view-toggle" title="Cambiar vista">
        <button id="cuViewToggle" class="btn btn-xs" data-mode="grid">Vista Lista</button>
      </div>
      <div class="cu-export">
        <button id="cuExportCSV" class="btn btn-outline btn-xs" title="Exportar jerarquÃ­a CSV">Export CSV</button>
      </div>
      <div class="cu-actions">
        <button class="btn btn-success btn-xs" data-open-modal="createCategoriaCultivo">+ Cat. Cultivo</button>
        <button class="btn btn-success btn-xs" data-open-modal="createTipoCultivo">+ Tipo</button>
        <button class="btn btn-success btn-xs" data-open-modal="createVariedadCultivo">+ Variedad</button>
        <button class="btn btn-warning btn-xs" data-open-modal="createCategoriaInsumo">+ Cat. Insumo</button>
        <button class="btn btn-warning btn-xs" data-open-modal="createInsumo">+ Insumo</button>
      </div>
    </div>
  </header>
  <div class="cu-metrics-bar" id="cuMetricsBar">
    <div class="cu-metric-pill" data-mx="promDias">Prom. dÃ­as: â€”</div>
    <div class="cu-metric-pill" data-mx="variedadTop">Variedad top: â€”</div>
    <div class="cu-metric-pill" data-mx="catActivas">Cat. con tipos: â€”</div>
    <div class="cu-metric-pill" data-mx="insumoTop">Cat. insumo top: â€”</div>
  </div>
  <section class="cu-panels">
    <div class="cu-panel active" data-cu-panel="cultivos" role="tabpanel">
      <ul id="cuListCultivos" class="cu-list cu-grid">
      <% categoriasCultivo.forEach(cat=> { const tipos = (tiposPorCategoria[cat.id_categoria]||[]); const avg = tipos.length ? Math.round(tipos.filter(t=>t.dias_cosecha).reduce((a,b)=> a + (b.dias_cosecha||0),0) / (tipos.filter(t=>t.dias_cosecha).length||1)) : null; %>
        <li class="cu-item" role="button" tabindex="0" data-kind="cultivo" data-entity="categoria-cultivo" data-id="<%= cat.id_categoria %>" data-name="<%= cat.nombre_categoria %>" data-count="<%= tipos.length %>" data-avg="<%= avg||'' %>" data-created="<%= (cat.created_at||'') %>">
          <div class="cu-row">
            <div class="cu-main" data-open-qv>
              <span class="cu-icon" <%= cat.icono? 'data-icon-key="'+cat.icono+'"':'' %>><%= cat.icono || 'ðŸŒ¿' %></span>
              <span class="cu-name"><%= cat.nombre_categoria %></span>
            </div>
            <div class="cu-stats">
              <span class="cu-metric" data-metric="count" title="Tipos"><%= tipos.length %></span>
              <% if (avg) { %><span class="cu-metric alt" data-metric="avg" title="Promedio dÃ­as"><%= avg %></span><% } %>
            </div>
            <div class="cu-actions-mini">
              <button class="mini fav" data-fav-toggle title="Favorito">â˜…</button>
              <button class="mini" data-edit="categoria-cultivo" data-id="<%= cat.id_categoria %>">E</button>
              <button class="mini" data-add-tipo data-id="<%= cat.id_categoria %>">+T</button>
              <button class="mini danger" data-delete="categoria-cultivo" data-id="<%= cat.id_categoria %>">Ã—</button>
            </div>
          </div>
        </li>
      <% }) %>
      </ul>
    </div>
    <div class="cu-panel" data-cu-panel="insumos" role="tabpanel">
      <ul id="cuListInsumos" class="cu-list cu-grid">
      <% categoriasInsumo.forEach(cat=> { const insCat = insumos.filter(i=> i.id_categoria_insumo === cat.id_categoria_insumo); %>
        <li class="cu-item" role="button" tabindex="0" data-kind="insumo" data-entity="categoria-insumo" data-id="<%= cat.id_categoria_insumo %>" data-name="<%= cat.nombre_categoria %>" data-count="<%= insCat.length %>" data-tipo="<%= cat.tipo||'' %>" data-created="<%= (cat.created_at||'') %>">
          <div class="cu-row">
            <div class="cu-main" data-open-qv>
              <span class="cu-icon ins" data-icon-insumo="<%= cat.tipo||'' %>">ðŸ“¦</span>
              <span class="cu-name"><%= cat.nombre_categoria %></span>
            </div>
            <div class="cu-stats">
              <span class="cu-metric" data-metric="count" title="Insumos"><%= insCat.length %></span>
              <% if (cat.tipo) { %><span class="cu-tag"><%= cat.tipo %></span><% } %>
            </div>
            <div class="cu-actions-mini">
              <button class="mini fav" data-fav-toggle title="Favorito">â˜…</button>
              <button class="mini" data-edit="categoria-insumo" data-id="<%= cat.id_categoria_insumo %>">E</button>
              <button class="mini" data-add-insumo data-id="<%= cat.id_categoria_insumo %>">+I</button>
              <button class="mini danger" data-delete="categoria-insumo" data-id="<%= cat.id_categoria_insumo %>">Ã—</button>
            </div>
          </div>
        </li>
      <% }) %>
      </ul>
    </div>
  </section>
</div>
