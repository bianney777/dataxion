
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/css/brand.css" />
</head>
<body class="brand-theme">
  <%- include('partial/header') %>
  <div class="layout">
    <%- include('partial/sidebar') %>
    <main class="feed">
      <section class="card animate-in" style="max-width:780px; margin:0 auto 34px;">
        <h2 style="font-size:2rem; letter-spacing:-1px; background:linear-gradient(90deg,#2563eb,#16a34a); -webkit-background-clip:text; background-clip:text; color:transparent;">Bienvenido</h2>
        <p style="color:#475569; font-size:.95rem; line-height:1.5; margin-bottom:22px;">Accede a la gestión de fincas y lotes desde el menú lateral o el botón rápido.</p>
        <a href="/gestionfinca" class="btn">Ir a Gestión de Fincas</a>
      </section>
      <!-- Panel de KPIs Agrícolas -->
      <section class="card animate-in" style="margin:0 0 34px; animation-delay:.05s;">
        <h3 style="font-size:1.15rem; margin:0 0 18px; letter-spacing:.5px; color:#0f172a;">Indicadores Clave</h3>
        <div style="display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); font-size:.65rem;">
          <div style="background:#f1f5f9; border:1px solid #e2e8f0; padding:12px 14px 14px; border-radius:14px; display:flex; flex-direction:column; gap:4px;">
            <span style="font-weight:600; color:#0A2A6B;">Ciclos Activos</span>
            <strong id="kpiCiclos" style="font-size:1.3rem;">—</strong>
            <span style="color:#64748b;">En seguimiento</span>
          </div>
          <div style="background:#f1f5f9; border:1px solid #e2e8f0; padding:12px 14px 14px; border-radius:14px; display:flex; flex-direction:column; gap:4px;">
            <span style="font-weight:600; color:#0A2A6B;">Prom. Avance</span>
            <strong id="kpiAvance" style="font-size:1.3rem;">—</strong>
            <span style="color:#64748b;">% global</span>
          </div>
          <div style="background:#f1f5f9; border:1px solid #e2e8f0; padding:12px 14px 14px; border-radius:14px; display:flex; flex-direction:column; gap:4px;">
            <span style="font-weight:600; color:#0A2A6B;">Costos / ha</span>
            <strong id="kpiCosto" style="font-size:1.3rem;">—</strong>
            <span style="color:#64748b;">Media estimada</span>
          </div>
          <div style="background:#f1f5f9; border:1px solid #e2e8f0; padding:12px 14px 14px; border-radius:14px; display:flex; flex-direction:column; gap:4px;">
            <span style="font-weight:600; color:#0A2A6B;">Rend. Proy.</span>
            <strong id="kpiRend" style="font-size:1.3rem;">—</strong>
            <span style="color:#64748b;">t/ha</span>
          </div>
        </div>
        <div style="display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); margin-top:22px; font-size:.6rem;">
          <div style="background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:14px 16px 16px;">
            <span style="font-weight:600; color:#0A2A6B;">Tendencia Avance</span>
            <svg viewBox="0 0 220 70" style="width:100%; margin-top:6px;">
              <polyline fill="none" stroke="#1B4DFF" stroke-width="3" stroke-linecap="round" points="6,58 28,50 50,48 72,40 94,36 116,30 138,24 170,18 214,14"/>
              <line x1="6" y1="62" x2="214" y2="62" stroke="#e2e8f0"/>
            </svg>
          </div>
          <div style="background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:14px 16px 16px;">
            <span style="font-weight:600; color:#0A2A6B;">Distribución Costos</span>
            <svg viewBox="0 0 220 70" style="width:100%; margin-top:6px;">
              <rect x="20" y="30" width="22" height="32" rx="3" fill="#1B4DFF" opacity=".55"/>
              <rect x="60" y="20" width="22" height="42" rx="3" fill="#1B4DFF"/>
              <rect x="100" y="26" width="22" height="36" rx="3" fill="#1B4DFF" opacity=".7"/>
              <rect x="140" y="18" width="22" height="44" rx="3" fill="#1B4DFF"/>
              <rect x="180" y="34" width="22" height="28" rx="3" fill="#1B4DFF" opacity=".6"/>
            </svg>
          </div>
          <div style="background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:14px 16px 16px;">
            <span style="font-weight:600; color:#0A2A6B;">Proyección Rendimiento</span>
            <svg viewBox="0 0 220 70" style="width:100%; margin-top:6px;">
              <defs>
                <linearGradient id="rendGrad" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#3CCB7F" stop-opacity=".85"/>
                  <stop offset="100%" stop-color="#3CCB7F" stop-opacity="0"/>
                </linearGradient>
              </defs>
              <path d="M6 54 L24 50 L42 44 L60 40 L78 34 L96 28 L114 24 L132 20 L150 16 L168 14 L188 12 L214 8 L214 70 L6 70 Z" fill="url(#rendGrad)" stroke="#3CCB7F" stroke-width="2"/>
            </svg>
          </div>
        </div>
      </section>
      <section class="grid" style="display:grid; gap:22px; grid-template-columns:repeat(auto-fill,minmax(260px,1fr));">
        <div class="card animate-in" style="animation-delay:.05s;">
          <h3 style="font-size:1rem;">Resumen rápido</h3>
          <ul style="list-style:none; padding:0; margin:0; font-size:.8rem; color:#475569; display:flex; flex-direction:column; gap:6px;">
            <li>Total de usuarios: <strong>—</strong></li>
            <li>Fincas registradas: <strong id="dashFincas">—</strong></li>
            <li>Lotes totales: <strong id="dashLotes">—</strong></li>
          </ul>
        </div>
        <div class="card animate-in" style="animation-delay:.1s;">
          <h3 style="font-size:1rem;">Actividad</h3>
          <p style="font-size:.75rem; color:#64748b;">Próximamente verás actividad reciente del sistema.</p>
        </div>
        <div class="card animate-in" style="animation-delay:.15s;">
          <h3 style="font-size:1rem;">Estado</h3>
          <p style="font-size:.75rem; color:#64748b;">Integraciones y servicios externos OK.</p>
        </div>
        <div class="card animate-in" style="animation-delay:.2s;">
          <h3 style="font-size:1rem;">Analizador</h3>
          <ul id="analisisLista" style="list-style:disc; padding-left:16px; margin:4px 0 0; font-size:.7rem; color:#475569; display:flex; flex-direction:column; gap:6px;">
            <li>Cargando heurísticas...</li>
          </ul>
        </div>
        <div class="card animate-in" style="animation-delay:.25s; position:relative; overflow:hidden;">
          <h3 style="font-size:1rem; display:flex; align-items:center; gap:6px;">Clima <span style="font-size:.55rem; background:#1B4DFF; color:#fff; padding:3px 6px; border-radius:6px; font-weight:600; letter-spacing:.5px;">LIVE</span></h3>
          <div id="weatherBox" style="font-size:.7rem; color:#475569; display:grid; grid-template-columns:repeat(auto-fit,minmax(90px,1fr)); gap:10px; margin-top:6px; align-items:center;">
            <div style="grid-column:1 / -1; display:flex; align-items:center; gap:10px;">
              <div id="wxIcon" style="width:52px; height:52px; border-radius:14px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#1B4DFF,#0A2A6B); color:#fff;">
                <svg viewBox="0 0 60 60" width="34" height="34" id="wxIconSvg"></svg>
              </div>
              <div style="display:flex; flex-direction:column; gap:4px;">
                <span style="font-size:.55rem; text-transform:uppercase; letter-spacing:.08em; color:#64748b;">Ubicación</span>
                <strong id="wxLocation" style="font-size:.85rem;">—</strong>
                <span id="wxCond" style="font-size:.6rem; font-weight:600; color:#0A2A6B;">—</span>
              </div>
              <div style="display:flex; flex-direction:column; gap:4px; margin-left:auto; text-align:right;">
                <span id="wxTemp" style="font-size:1.4rem; font-weight:600; background:linear-gradient(90deg,#1B4DFF,#3CCB7F); -webkit-background-clip:text; background-clip:text; color:transparent;">—</span>
                <span id="wxHum" style="font-size:.6rem; color:#475569;">—</span>
              </div>
            </div>
            <div style="grid-column:1 / -1; display:flex; gap:8px; flex-wrap:wrap; font-size:.55rem;">
              <span id="wxMeta" style="background:#f1f5f9; border:1px solid #e2e8f0; padding:4px 8px; border-radius:8px;">Esperando geolocalización...</span>
              <button id="wxReintentar" style="background:#1B4DFF; color:#fff; border:none; padding:4px 10px; border-radius:8px; font-size:.55rem; cursor:pointer; font-weight:600; letter-spacing:.5px;">Reintentar</button>
            </div>
            <div style="grid-column:1 / -1; font-size:.5rem; color:#64748b; margin-top:4px;">Fuente: Open‑Meteo · Actualiza cada 15 min</div>
          </div>
        </div>
      </section>
    </main>
    <aside class="rightbar">
      <div class="right-card">
        <h4 class="text-xs font-semibold tracking-wider" style="text-transform:uppercase; font-size:.65rem; letter-spacing:.08em; color:#64748b;">Accesos rápidos</h4>
        <a href="/gestionfinca" class="btn" style="width:100%;">Gestión de Fincas</a>
      </div>
      <div class="right-card">
        <h4 class="text-xs font-semibold tracking-wider" style="text-transform:uppercase; font-size:.65rem; letter-spacing:.08em; color:#64748b;">Tema</h4>
        <button id="toggleThemeDash" class="btn-outline btn" style="width:100%;">Alternar Tema</button>
      </div>
    </aside>
  </div>
  <script>
    // Theme toggle reutilizable si ya existe toggleTheme en otras vistas
    const root = document.documentElement;
    function applyStoredTheme(){
      const t = localStorage.getItem('theme');
      if(t==='dark'){ root.classList.add('dark'); }
      else { root.classList.remove('dark'); }
    }
    applyStoredTheme();
    document.getElementById('toggleThemeDash')?.addEventListener('click', ()=>{
      const isDark = root.classList.toggle('dark');
      localStorage.setItem('theme', isDark? 'dark':'light');
    });

    // Carga de datos del dashboard (simulación + API futura)
    async function cargarDashboard(){
      try {
        const res = await fetch('/api/dashboard/data');
        if(!res.ok) throw new Error('No se pudo obtener /api/dashboard/data');
        const data = await res.json();
        // Simulación de KPIs (si en respuesta futura vienen reales se reemplaza)
        document.getElementById('kpiCiclos').textContent = data.stats?.activeServices || 0;
        document.getElementById('kpiAvance').textContent = '63%';
        document.getElementById('kpiCosto').textContent = '$412';
        document.getElementById('kpiRend').textContent = '8.2';
        // Heurísticas / analizador
        const analisis = [];
        if(data.stats){
          if(data.stats.activeServices > 3) analisis.push('Suficiente base para métricas agregadas.');
          if(data.stats.monthlyRevenue > 1000) analisis.push('Ingresos mensuales indican tracción inicial.');
        }
        analisis.push('Promedio de avance estable por encima del 60%.');
        analisis.push('Costos/ha dentro del rango objetivo preliminar.');
        const ul = document.getElementById('analisisLista');
        ul.innerHTML = '';
        analisis.forEach(a=>{ const li=document.createElement('li'); li.textContent=a; ul.appendChild(li); });
      } catch(err){
        console.error(err);
      }
    }
    cargarDashboard();

    // Gadget clima con geolocalización
    let climaCoords = { lat: null, lon: null };
    let climaInterval = null;

    async function solicitarGeo(){
      const meta = document.getElementById('wxMeta');
      meta.textContent = 'Solicitando geolocalización...';
      if(!navigator.geolocation){ meta.textContent = 'Geolocalización no soportada'; return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        climaCoords.lat = pos.coords.latitude;
        climaCoords.lon = pos.coords.longitude;
        meta.textContent = 'Ubicación detectada';
        cargarClima();
        if(climaInterval) clearInterval(climaInterval);
        climaInterval = setInterval(cargarClima, 1000*60*15);
      }, err=>{
        meta.textContent = 'No se pudo obtener ubicación ('+err.code+')';
      }, { enableHighAccuracy:false, timeout:8000, maximumAge:600000 });
    }

    async function cargarClima(){
      try {
        if(climaCoords.lat==null || climaCoords.lon==null){ return; }
        const { lat, lon } = climaCoords;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code`; 
        const r = await fetch(url);
        if(!r.ok) throw new Error('Fallo clima');
        const j = await r.json();
        const c = j.current || {};
        document.getElementById('wxLocation').textContent = lat.toFixed(2)+','+lon.toFixed(2);
        document.getElementById('wxTemp').textContent = (c.temperature_2m!==undefined? Math.round(c.temperature_2m)+'°C':'—');
        document.getElementById('wxHum').textContent = (c.relative_humidity_2m!==undefined? c.relative_humidity_2m+'% H':'—');
        const cond = mapWeatherCode(c.weather_code);
        document.getElementById('wxCond').textContent = cond.label;
        renderWeatherIcon(cond.icon);
        const meta = document.getElementById('wxMeta');
        meta.textContent = 'Actualizado: '+ new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
      } catch(e){ console.warn('No se pudo cargar clima:', e.message); }
    }

    function mapWeatherCode(code){
      if(code===0) return { label:'Despejado', icon:'sun' };
      if([1,2].includes(code)) return { label:'Parcial', icon:'partly' };
      if(code===3) return { label:'Nublado', icon:'cloud' };
      if([45,48].includes(code)) return { label:'Niebla', icon:'fog' };
      if([51,53,55].includes(code)) return { label:'Llovizna', icon:'drizzle' };
      if([61,63,65].includes(code)) return { label:'Lluvia', icon:'rain' };
      if([71,73,75].includes(code)) return { label:'Nieve', icon:'snow' };
      if([95,96,99].includes(code)) return { label:'Tormenta', icon:'storm' };
      return { label:'—', icon:'unknown' };
    }

    function renderWeatherIcon(type){
      const svg = document.getElementById('wxIconSvg');
      if(!svg) return;
      const common = 'stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"';
      let content='';
      switch(type){
        case 'sun': content = '<circle cx="30" cy="30" r="12" fill="rgba(255,255,255,.3)" stroke="#fff" stroke-width="2"/>'+
          '<g '+common+'><line x1="30" y1="8" x2="30" y2="2"/><line x1="30" y1="58" x2="30" y2="52"/><line x1="8" y1="30" x2="2" y2="30"/><line x1="58" y1="30" x2="52" y2="30"/><line x1="46" y1="14" x2="50" y2="10"/><line x1="14" y1="46" x2="10" y2="50"/><line x1="14" y1="14" x2="10" y2="10"/><line x1="46" y1="46" x2="50" y2="50"/></g>'; break;
        case 'partly': content = '<circle cx="22" cy="24" r="10" fill="rgba(255,255,255,.25)" stroke="#fff" stroke-width="2"/>'+
          '<path d="M36 46c6 0 10-4 10-9s-4-9-10-9c-.7 0-1.4.06-2 .18A8 8 0 0 0 16 33c0 7 6 13 13 13h7z" fill="rgba(255,255,255,.55)" stroke="#fff" stroke-width="2"/>'; break;
        case 'cloud': content = '<path d="M18 43c-5 0-9-4-9-9s4-9 9-9c.9 0 1.8.14 2.6.4C22.4 21.5 27 18 32.5 18 39.4 18 45 23.6 45 30.5c0 .5 0 1-.1 1.5 3 .8 5.1 3.5 5.1 6.6 0 3.7-3 6.7-6.7 6.7H18z" fill="rgba(255,255,255,.5)" stroke="#fff" stroke-width="2"/>'; break;
        case 'fog': content = '<path d="M14 34h32M10 40h40M18 46h24" '+common+'/>'+'<path d="M18 30c-3 0-6-3-6-6s3-6 6-6c.6 0 1.2.1 1.8.3C21 15 25 12 30 12c6 0 11 5 11 11 0 .4 0 .8-.1 1.2 2.4.6 4.1 2.9 4.1 5.3 0 3-2.4 5.5-5.5 5.5H18z" fill="rgba(255,255,255,.4)" stroke="#fff" stroke-width="2"/>'; break;
        case 'drizzle': content = '<path d="M18 36c-5 0-9-4-9-9s4-9 9-9c.9 0 1.8.14 2.6.4C22.4 14.5 27 11 32.5 11 39.4 11 45 16.6 45 23.5c0 .5 0 1-.1 1.5 3 .8 5.1 3.5 5.1 6.6 0 3.7-3 6.7-6.7 6.7H18z" fill="rgba(255,255,255,.45)" stroke="#fff" stroke-width="2"/>'+
          '<g '+common+'><line x1="22" y1="44" x2="20" y2="50"/><line x1="30" y1="44" x2="28" y2="50"/><line x1="38" y1="44" x2="36" y2="50"/></g>'; break;
        case 'rain': content = '<path d="M18 36c-5 0-9-4-9-9s4-9 9-9c.9 0 1.8.14 2.6.4C22.4 14.5 27 11 32.5 11 39.4 11 45 16.6 45 23.5c0 .5 0 1-.1 1.5 3 .8 5.1 3.5 5.1 6.6 0 3.7-3 6.7-6.7 6.7H18z" fill="rgba(255,255,255,.45)" stroke="#fff" stroke-width="2"/>'+
          '<g '+common+'><line x1="22" y1="44" x2="19" y2="52"/><line x1="30" y1="44" x2="27" y2="52"/><line x1="38" y1="44" x2="35" y2="52"/><line x1="46" y1="44" x2="43" y2="52"/></g>'; break;
        case 'snow': content = '<path d="M18 36c-5 0-9-4-9-9s4-9 9-9c.9 0 1.8.14 2.6.4C22.4 14.5 27 11 32.5 11 39.4 11 45 16.6 45 23.5c0 .5 0 1-.1 1.5 3 .8 5.1 3.5 5.1 6.6 0 3.7-3 6.7-6.7 6.7H18z" fill="rgba(255,255,255,.45)" stroke="#fff" stroke-width="2"/>'+
          '<g '+common+'><path d="M30 42l0 8"/><path d="M26 44l8 4"/><path d="M34 44l-8 4"/><path d="M26 50l8 -4"/><path d="M34 50l-8 -4"/></g>'; break;
        case 'storm': content = '<path d="M18 36c-5 0-9-4-9-9s4-9 9-9c.9 0 1.8.14 2.6.4C22.4 14.5 27 11 32.5 11 39.4 11 45 16.6 45 23.5c0 .5 0 1-.1 1.5 3 .8 5.1 3.5 5.1 6.6 0 3.7-3 6.7-6.7 6.7H18z" fill="rgba(255,255,255,.45)" stroke="#fff" stroke-width="2"/>'+
          '<polyline points="30,42 26,50 34,48 30,56" '+common+' />'; break;
        default: content = '<circle cx="30" cy="30" r="10" fill="rgba(255,255,255,.3)" stroke="#fff" stroke-width="2"/>';
      }
      svg.innerHTML = content;
    }

    document.getElementById('wxReintentar')?.addEventListener('click', solicitarGeo);
    // Inicio
    solicitarGeo();
  </script>
</body>
</html>
